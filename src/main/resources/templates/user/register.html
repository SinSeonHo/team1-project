<!DOCTYPE html>
<html lang="en" layout:decorate="~{layouts/layout}">
  <th:block layout:fragment="css">
    <style>
      .input-item {
        position: relative;
        margin-bottom: 1rem;
      }

      .input-item input,
      .input-item select {
        padding-left: 2.5rem;
        height: 45px;
      }

      .input-icon {
        position: absolute;
        top: 50%;
        left: 0.75rem;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
      }

      .toggle-password {
        position: absolute;
        top: 50%;
        right: 0.75rem;
        transform: translateY(-50%);
        color: #6c757d;
        cursor: pointer;
      }

      .false-icon {
        color: red;
      }

      .reverse {
        background-color: #1976d2;
      }

      .text-red {
        color: #e53637;
      }

      /* 기본 placeholder 스타일 */
      ::placeholder {
        color: #6c757d;
        opacity: 1;
      }

      .input-error {
        border-color: red;
      }

      /* 에러 클래스가 붙은 경우 placeholder 색상 변경 */
      .input-error::placeholder {
        color: red;
        opacity: 1;
      }

      /* select의 placeholder 역할(첫 번째 option) 빨간색 */
      .input-error option:first-child {
        color: red;
      }
    </style>
  </th:block>
  <div layout:fragment="header"></div>
  <main
    layout:fragment="content"
    th:object="${totalUserDTO}"
    th:with="isSocial=${not #strings.isEmpty(totalUserDTO.email)}"
  >
    <div class="container mt-5">
      <div class="d-flex flex-column justify-content-center align-items-center">
        <h2 class="mb-2">회원정보 입력</h2>
        <form th:action="@{/user/register}" th:object="${totalUserDTO}" method="post" class="registerForm w-50 my-2">
          <!-- 이름 -->
          <div class="input-item" th:with="err=${#fields.hasErrors('name')}">
            <input
              type="text"
              class="form-control w-100"
              name="name"
              th:value="${err} ? ${totalUserDTO.name} : ''"
              th:placeholder="${err} ? ${#fields.errors('name')[0]} : '이름'"
              th:classappend="${err} ? 'input-error' : ''"
            />
            <span class="fas fa-user input-icon" th:classappend="${err} ? 'false-icon' : ''"></span>
          </div>

          <!-- 닉네임 -->
          <div class="input-item" th:with="err=${#fields.hasErrors('nickname')}">
            <input
              type="text"
              class="form-control w-100"
              name="nickname"
              th:value="${err} ? ${totalUserDTO.nickname} : '' "
              th:placeholder="${err} ? ${#fields.errors('nickname')[0]} : '별명'"
              th:classappend="${err} ? 'input-error' : ''"
            />
            <span class="fas fa-solid fa-circle-user input-icon" th:classappend="${err} ? 'false-icon' : ''"></span>
          </div>
          <!-- 아이디 -->
          <div class="input-item" th:with="err=${#fields.hasErrors('id')}, isSocial=${totalUserDTO.email != null}">
            <!-- 일반 가입 -->
            <input
              type="text"
              class="form-control"
              name="id"
              th:if="${!isSocial}"
              th:value="${err} ? ${totalUserDTO.id} : ''"
              th:placeholder="${(err and !isSocial) ? #fields.errors('id')[0] : '아이디'}"
              th:classappend="${(err and !isSocial) ? 'input-error' : ''}"
            />

            <!-- 소셜 로그인 표시용(제출되지 않음) -->
            <input type="text" class="form-control" th:if="${isSocial}" placeholder="소셜 계정" disabled />

            <!-- 실제 제출값: JS에서 이메일 기반으로 특수문자 제거 후 넣어줌 -->
            <input type="hidden" name="id" th:if="${isSocial}" />
            <span class="fas fa-id-badge input-icon" th:classappend="${(err and !isSocial) ? 'false-icon' : ''}"></span>
          </div>

          <!-- 비밀번호 -->
          <div
            class="input-item"
            style="position: relative"
            th:with="err=${#fields.hasErrors('password')}, isSocial=${totalUserDTO.email != null}"
          >
            <input
              type="password"
              class="form-control"
              name="password"
              th:if="${!isSocial}"
              th:placeholder="${(err and !isSocial) ? #fields.errors('password')[0] : '비밀번호'}"
              th:classappend="${(err and !isSocial) ? 'input-error' : ''}"
            />
            <input type="password" class="form-control" th:if="${isSocial}" placeholder="소셜 계정" disabled />
            <input type="hidden" name="password" th:value="${totalUserDTO.email}" th:if="${isSocial}" />
            <span class="fas fa-lock input-icon" th:classappend="${(err and !isSocial) ? 'false-icon' : ''}"></span>
            <span class="fas fa-eye toggle-password" th:if="${!isSocial}"></span>
          </div>

          <!-- 비밀번호 확인 -->
          <div
            class="input-item"
            style="position: relative"
            th:with="err=${#fields.hasErrors('checkPassword')}, isSocial=${totalUserDTO.email != null}"
          >
            <input
              type="password"
              class="form-control"
              name="checkPassword"
              th:if="${!isSocial}"
              th:value="${err} ? ${totalUserDTO.checkPassword} : ''"
              th:placeholder="${(err and !isSocial) ? #fields.errors('checkPassword')[0] : '비밀번호 확인'}"
              th:classappend="${(err and !isSocial) ? 'input-error' : ''}"
            />
            <input type="password" class="form-control" th:if="${isSocial}" placeholder="소셜 계정" disabled />
            <input type="hidden" name="checkPassword" th:value="${totalUserDTO.email}" th:if="${isSocial}" />
            <span class="fas fa-lock input-icon" th:classappend="${(err and !isSocial) ? 'false-icon' : ''}"></span>
            <span class="fas fa-eye toggle-password" th:if="${!isSocial}"></span>
          </div>

          <!-- 나이 -->
          <div class="input-item" th:with="err=${#fields.hasErrors('age')}">
            <input
              type="number"
              class="form-control"
              name="age"
              th:value="${err} ? ${totalUserDTO.age} :  ''"
              th:placeholder="${err} ? ${#fields.errors('age')[0]} : '나이'"
              min="0"
              max="100"
              th:classappend="${err} ? 'input-error' : ''"
              autocomplete="off"
              inputmode="numeric"
              pattern="[0-9]*"
              oninput="this.value=this.value.replace(/[^0-9]/g,'');"
            />
            <span class="fas fa-calendar input-icon" th:classappend="${err} ? 'false-icon' : ''"></span>
          </div>

          <!-- 성별 -->
          <div class="input-item" th:with="err=${#fields.hasErrors('gender')}">
            <select class="form-control" name="gender" th:classappend="${err} ? 'input-error' : ''">
              <option value="" disabled th:selected="${totalUserDTO.gender == null}">성별 선택</option>
              <option value="MAN" th:selected="${totalUserDTO.gender == 'MAN'}">남자</option>
              <option value="WOMAN" th:selected="${totalUserDTO.gender == 'WOMAN'}">여자</option>
            </select>
            <span class="fas fa-venus-mars input-icon"></span>
          </div>
          <input type="hidden" name="email" th:if="${isSocial}" th:value="${totalUserDTO.email}" />
        </form>

        <div class="input-item">
          <button type="button" class="site-btn mx-1 ok">결정</button>
          <!-- 숨은 로그아웃 폼 -->
          <form id="logoutForm" th:action="@{/logout}" method="post" style="display: none">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          </form>

          <!-- 버튼 -->
          <button
            type="button"
            class="site-btn reverse mx-1"
            th:onclick="|document.getElementById('logoutForm').submit()|"
          >
            취소
          </button>
        </div>
      </div>
    </div>
  </main>
  <th:block layout:fragment="script">
    <script th:inline="javascript">
      (function () {
        const registerForm = document.querySelector(".registerForm");
        const submitBtn = document.querySelector(".ok");
        if (!registerForm || !submitBtn) return;

        // Thymeleaf 값 주입 (서버에서 치환됨)
        const isSocial = /*[[${not #strings.isEmpty(totalUserDTO.email)}]]*/ false;
        const emailVal = /*[[${totalUserDTO.email}]]*/ "";

        // 이메일 -> 안전한 아이디(영/숫자만)로 변환
        function toSafeId(email) {
          if (!email) return "";
          const local = String(email).split("@")[0].toLowerCase();
          const safe = local.replace(/[^a-z0-9]/g, "");
          return safe || "user" + Date.now();
        }

        // 제출 버튼(단일 리스너)
        submitBtn.addEventListener("click", function (e) {
          e.preventDefault();

          if (isSocial && emailVal) {
            // 히든 id 채우기(특수문자 제거된 값)
            const hiddenId = registerForm.querySelector('input[name="id"][type="hidden"]');
            if (hiddenId) hiddenId.value = toSafeId(emailVal);

            // 히든 password / checkPassword 는 이메일 그대로
            const hiddenPw = registerForm.querySelector('input[name="password"][type="hidden"]');
            const hiddenPw2 = registerForm.querySelector('input[name="checkPassword"][type="hidden"]');
            if (hiddenPw) hiddenPw.value = emailVal;
            if (hiddenPw2) hiddenPw2.value = emailVal;
          }

          registerForm.submit();
        });

        // 비밀번호 토글(존재하는 아이콘에만 바인딩, 중복 바인딩 제거)
        document.querySelectorAll(".toggle-password").forEach((eyeIcon) => {
          eyeIcon.addEventListener("click", () => {
            const input = eyeIcon.parentElement.querySelector("input.form-control");
            if (!input) return;
            input.type = input.type === "password" ? "text" : "password";
            eyeIcon.classList.toggle("fa-eye");
            eyeIcon.classList.toggle("fa-eye-slash");
          });
        });
      })();
    </script>
  </th:block>
</html>
