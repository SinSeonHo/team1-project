<!DOCTYPE html>
<html lang="en" layout:decorate="~{layouts/layout}">
  <body>
    <div layout:fragment="content">
      <!-- 자식 템플릿 전용 스타일 (head 밖, content 내부 최상단에 둠) -->
      <style>
        /* 강제 덮어쓰기 */
        .anime__details__widget ul li span {
          width: auto !important;
          display: inline !important;
          color: inherit !important;
        }
        .anime__details__widget li {
          list-style: none;
          font-size: 16px;
          line-height: 32px;
          color: #ffffff;
          font-weight: 400;
        }

        .anime__details__widget li span:first-child {
          color: #b7b7b7; /* 라벨(왼쪽) 색상 */
          font-weight: 600;
          margin-right: 10px;
          display: inline-block;
          min-width: 100px; /* 라벨 길이 통일 */
        }

        .anime__details__widget li span:last-child {
          color: #ffffff; /* 값(오른쪽) 색상 */
          font-weight: 400;
        }
      </style>

      <div class="gradient-bg">
        <!-- 영화상세페이지 -->
        <div class="breadcrumb-option">
          <div class="container">
            <div class="col-lg-12">
              <a th:href="@{/}">Home</a>
              <a href="#">></a>
              <a th:href="@{/api/movies/list}">MovieList</a>
              <a href="#">></a>
              <a href="#">MovieInfo</a>
            </div>
          </div>
        </div>

        <!-- 상세정보 -->
        <section class="anime-details spad">
          <div class="container">
            <div class="anime__details__content">
              <div class="row">
                <div class="col-lg-3">
                  <img
                    th:src="@{${movieInfo.image != null} ? '/images/movieimages/' + ${movieInfo.image.imgName} : '/images/sample.png'}"
                    onerror="this.onerror=null; this.src='/images/sample.jpg';"
                    alt="영화 이미지"
                    loading="lazy"
                    class="anime__details__pic"
                  />
                </div>
                <div class="col-lg-9">
                  <div class="anime__details__text">
                    <div class="anime__details__title">
                      <h3 th:text="${movieInfo.title}"></h3>
                      <span th:text="'감독 : ' + ${movieInfo.director}"></span>
                      <span th:text="'배우 : ' + ${movieInfo.actors}"></span>
                      <br />
                      <h4 th:text="시놉시스" class="synopsis_t"></h4>
                      <span th:text="${movieInfo.synopsis}" class="synopsis"></span>
                    </div>

                    <div class="anime__details__widget">
                      <div class="row">
                        <div class="col-lg-6 col-md-6">
                          <ul>
                            <li><span>개봉일</span> <span th:text="${movieInfo.openDate}"></span></li>
                            <li><span>장르</span><span th:text="${movieInfo.genres}"></span></li>
                            <li><span>상영시간</span><span th:text="${showTm}"></span></li>
                            <li><span>적정관람등급</span><span th:text="${movieInfo.gradeNm}"></span></li>
                            <li><span>개봉국가</span><span th:text="${movieInfo.nationNm}"></span></li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="anime__details__btn" th:if="${#authentication.name !='anonymousUser'}">
                      <button
                        class="follow-btn"
                        th:classappend="${isFollowed} ? ' follow' : ''"
                        th:data-mid="${movieInfo.mid}"
                        th:text="${isFollowed} ? 'Followed' : 'Follow'"
                      ></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 스크린샷 이미지 리스트 -->
            <div class="slider-container" id="sliderContainer">
              <div class="slider" id="slider">
                <img th:each="url : ${screenshotUrls}" th:src="${url}" alt="스크린샷 이미지" />
              </div>
            </div>

            <!-- 모달창 -->
            <div id="modal" class="modal" style="display: none">
              <span id="modalClose" class="modal-close">&times;</span>
              <button id="prevBtn" class="nav-btn prev-btn">&#10094;</button>
              <img id="modalImg" src="" alt="확대 이미지" />
              <button id="nextBtn" class="nav-btn next-btn">&#10095;</button>
            </div>

            <div class="center-line"></div>
          </div>
        </section>

        <!-- 댓글 영역 -->
        <div class="col-lg-6 mx-auto">
          <div class="anime__details__review">
            <div class="section-title">
              <h5 id="replyCnt" th:text="'댓글 ' + ${replies.size} + '개'"></h5>
            </div>
            <div class="p-4"></div>

            <!-- 댓글 시작 -->
            <div th:each="reply : ${replies}" class="anime__review__item">
              <div class="anime__review__item__pic" th:classappend="${reply.ref != null} ? 're-reply'">
                <img
                  th:src="${reply.thumbnailPath == null} ? '/images/sample.jpg' : '/images/view/' + ${reply.thumbnailPath}"
                  alt="프로필"
                  class="rounded-circle border border-primary shadow-sm"
                  style="width: 40px; height: 40px; object-fit: cover; background: #eee"
                />
              </div>
              <div
                class="anime__review__item__text reply"
                th:data-rno="${reply.rno}"
                th:data-replyer="${reply.replyer}"
                th:data-replyerNickname="${reply.replyerNickname}"
                th:data-text="${reply.text}"
                th:data-id="${reply.mid}"
                th:data-mention="${reply.mention}"
                th:data-ref="${reply.ref}"
              >
                <span class="replyer text-light" th:text="${reply.replyerNickname}"></span>
                <span
                  class="text-secondary"
                  th:if="${reply.mention}"
                  th:text="' - ' + ${reply.mention} + '에게'"
                ></span>
                <span class="text-secondary" th:text="${reply.createdDate}"></span>
                <button
                  type="button"
                  class="delete-btn btn btn-secondary btn-sm"
                  th:data-rno="${reply.rno}"
                  th:if="${#authentication.name == reply.replyer}"
                >
                  x
                </button>
                <button
                  type="button"
                  class="update-btn btn btn-secondary btn-sm"
                  th:data-rno="${reply.rno}"
                  th:if="${#authentication.name == reply.replyer}"
                >
                  수정
                </button>
                <button
                  type="button"
                  class="mention-btn btn btn-secondary btn-sm"
                  th:data-rno="${reply.rno}"
                  th:if="${#authentication.name != 'anonymousUser'}"
                >
                  대댓글
                </button>
                <p th:text="${reply.text}">댓글 텍스트</p>
              </div>
            </div>
            <!-- 댓글 리스트 끝 -->
          </div>

          <!-- 댓글 작성 폼 -->
          <div class="anime__details__form">
            <div class="section-title">
              <h5>댓글 작성</h5>
            </div>
            <span class="mention text-light"></span>
            <form id="replyForm" method="post">
              <input type="hidden" name="mid" th:value="${movieInfo.mid}" />
              <input type="hidden" name="rno" />
              <input type="hidden" name="replyer" th:value="${#authentication.name}" />
              <input type="hidden" name="mention" />
              <input type="hidden" name="ref" />
              <textarea name="text" placeholder="Your Comment"></textarea>
              <button class="btn btn-insert" type="submit" style="font-size: medium">등록</button>
              <button class="btn btn-cancel" type="button" style="font-size: medium">취소</button>
            </form>
          </div>
          <!-- 댓글 작성 폼 끝 -->
        </div>
      </div>

      <script>
        const mid = "[[${movieInfo.mid}]]";
        const csrf = "[[${_csrf.token}]]";
      </script>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <script th:src="@{/js/reply.js}"></script>
      <script th:src="@{/js/followbtn.js}"></script>
      <script th:src="@{/js/imgSlider.js}"></script>
      <script th:src="@{/js/imgModal.js}"></script>
    </div>
  </body>
</html>
