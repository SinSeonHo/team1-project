<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}">
  <th:block layout:fragment="title"></th:block>
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>

  <!-- CSRF ë©”íƒ€íƒœê·¸ -->
  <th:block layout:fragment="metadata">
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}" />
  </th:block>

  <!-- ì‹ ê³  ë¦¬ìŠ¤íŠ¸ ì „ìš© ìµœì†Œ ìŠ¤íƒ€ì¼ -->
  <th:block layout:fragment="css">
    <style>
      table.report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      table.report-table th,
      table.report-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      td,
      label {
        color: #ffffff;
      }
      table.report-table th {
        background-color: #f4f4f4;
      }
      .status-received {
        color: orange;
        font-weight: bold;
      }
      .status-warning {
        color: #ffcc00;
        font-weight: bold;
      }
      .status-deleted {
        color: red;
        font-weight: bold;
      }
      .status-noaction {
        color: #9aa0a6;
        font-weight: bold;
      }
      .btn {
        padding: 6px 10px;
        border: none;
        background: #007bff;
        color: white;
        border-radius: 4px;
        text-decoration: none;
        cursor: pointer;
      }
      .btn:hover {
        background: #0056b3;
      }
      .search-form {
        margin-top: 20px;
        margin-bottom: 10px;
      }
      .btn-reset {
        margin-left: 6px;
        background: #6c757d;
      }
      .btn-reset:hover {
        background: #5a6268;
      }
    </style>
  </th:block>

  <body>
    <main layout:fragment="content">
      <div class="container">
        <h1 class="text-center">ê´€ë¦¬ì ì‹ ê³  ë¦¬ìŠ¤íŠ¸</h1>

        <!-- ğŸ” ê²€ìƒ‰ & í•„í„° (ì „ì²´ë³´ê¸° option ì œê±°) -->
        <form method="get" th:action="@{/report/list}" class="search-form text-center" id="report-filter-form">
          <label>
            ì‚¬ìœ (ë‹¤ì¤‘):
            <select name="reasons">
              <option
                th:value="${T(com.example.ott.type.Reason).PROFANITY}"
                th:selected="${reasons != null and #lists.contains(reasons, T(com.example.ott.type.Reason).PROFANITY)}"
              >
                ìš•ì„¤
              </option>
              <option
                th:value="${T(com.example.ott.type.Reason).INAPPROPRIATE_NICKNAME}"
                th:selected="${reasons != null and #lists.contains(reasons, T(com.example.ott.type.Reason).INAPPROPRIATE_NICKNAME)}"
              >
                ë¶€ì ì ˆí•œ ë‹‰ë„¤ì„
              </option>
              <option
                th:value="${T(com.example.ott.type.Reason).SPOILER}"
                th:selected="${reasons != null and #lists.contains(reasons, T(com.example.ott.type.Reason).SPOILER)}"
              >
                ìŠ¤í¬ì¼ëŸ¬
              </option>
              <option
                th:value="${T(com.example.ott.type.Reason).ADVERTISEMENT}"
                th:selected="${reasons != null and #lists.contains(reasons, T(com.example.ott.type.Reason).ADVERTISEMENT)}"
              >
                ê´‘ê³ 
              </option>
            </select>
          </label>

          <label>
            ìƒíƒœ(ë‹¤ì¤‘):
            <select name="statuses">
              <option
                th:value="${T(com.example.ott.type.Status).RECEIVED}"
                th:selected="${statuses != null and #lists.contains(statuses, T(com.example.ott.type.Status).RECEIVED)}"
              >
                ì ‘ìˆ˜ë¨
              </option>
              <option
                th:value="${T(com.example.ott.type.Status).WARNING}"
                th:selected="${statuses != null and #lists.contains(statuses, T(com.example.ott.type.Status).WARNING)}"
              >
                ê²½ê³ 
              </option>
              <option
                th:value="${T(com.example.ott.type.Status).DELETED}"
                th:selected="${statuses != null and #lists.contains(statuses, T(com.example.ott.type.Status).DELETED)}"
              >
                ì‚­ì œ
              </option>
              <option
                th:value="${T(com.example.ott.type.Status).NO_ACTION}"
                th:selected="${statuses != null and #lists.contains(statuses, T(com.example.ott.type.Status).NO_ACTION)}"
              >
                ë¬´í˜ì˜
              </option>
            </select>
          </label>

          <button type="submit" class="btn">ê²€ìƒ‰</button>
          <!-- ì´ˆê¸°í™” ë²„íŠ¼(íŒŒë¼ë¯¸í„° ì—†ì´ /report/listë¡œ ì´ë™) -->
          <a class="btn btn-reset" th:href="@{/report/list}">ì´ˆê¸°í™”</a>
        </form>

        <!-- ğŸ“‹ ì‹ ê³  ë¦¬ìŠ¤íŠ¸ -->
        <table class="report-table">
          <thead>
            <tr>
              <th>ë²ˆí˜¸</th>
              <th>ì‹ ê³ ì ID</th>
              <th>ëŒ€ìƒ ë‹‰ë„¤ì„</th>
              <th>ì‹ ê³  ì‚¬ìœ </th>
              <th>ê²Œì‹œê¸€</th>
              <th>ì‹ ê³  ì¼ì‹œ</th>
              <th>ì²˜ë¦¬ ìƒíƒœ</th>
              <th>ë³€ê²½</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="report, iterStat : ${page.content}">
              <td th:text="${iterStat.index + 1}">1</td>

              <td
                th:text="${report.reporterId != null ? report.reporterId : (report.reporter != null ? report.reporter.id : '-') }"
              >
                user01
              </td>

              <td
                th:text="${report.replyNickName != null ? report.replyNickName
                          : (report.reply != null and report.reply.replyer != null ? report.reply.replyer.nickname : '-') }"
              >
                ì„êº½ì •
              </td>

              <!-- ì‹ ê³  ì‚¬ìœ  (ì›ë³¸: enum ì´ë¦„ ê·¸ëŒ€ë¡œ) -->
              <td th:text="${report.reason}">PROFANITY</td>

              <td>
                <a
                  th:href="@{/posts/{postId}(postId=${report.replyId != null ? report.replyId : (report.reply != null ? report.reply.rno : 0)})}"
                  target="_blank"
                  >ë³´ê¸°</a
                >
              </td>

              <!-- ì‹ ê³  ì¼ì‹œ (ì›ë³¸ ë¡œì§) -->
              <td th:text="${ #temporals.format(report.handleDate ?: report.updatedDate, 'yyyy-MM-dd HH:mm') }">-</td>

              <!-- ì²˜ë¦¬ ìƒíƒœ + í´ë˜ìŠ¤ ë§¤í•‘ (ì›ë³¸: enum ì´ë¦„ ê¸°ì¤€) -->
              <td
                class="set-status"
                th:data-id="${report.id}"
                th:data-status="${report.status}"
                th:text="${report.status}"
                th:classappend="${
                    report.status == 'RECEIVED' ? ' status-received' :
                    (report.status == 'WARNING' ? ' status-warning' :
                    (report.status == 'DELETED' ? ' status-deleted' :
                    (report.status == 'NO_ACTION' ? ' status-noaction' : '')))
                  }"
              ></td>

              <td>
                <button type="button" class="btn-update" th:data-id="${report.id}" th:data-reason="${report.reason}">
                  Update
                </button>
              </td>
            </tr>

            <tr th:if="${#lists.isEmpty(page.content)}">
              <td colspan="8" style="color: #fff">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <th:block layout:fragment="script">
        <script th:src="@{/js/admin.js}"></script>
        <script>
          (function () {
            const ORDER = ["RECEIVED", "WARNING", "DELETED", "NO_ACTION"];

            document.addEventListener("click", function (e) {
              const cell = e.target.closest(".set-status");
              if (!cell) return;
              const current = cell.getAttribute("data-status") || "";
              const idx = ORDER.indexOf(current);
              const next = ORDER[(idx + 1 + ORDER.length) % ORDER.length];
              cell.setAttribute("data-status", next);
              cell.textContent = next;
              cell.className = "set-status " + statusToClass(next);
            });

            // âœ… Update ë²„íŠ¼: status + reason ì „ì†¡
            document.addEventListener("click", function (e) {
              const btn = e.target.closest(".btn-update");
              if (!btn) return;

              const id = btn.getAttribute("data-id");
              const row = btn.closest("tr");
              const cell = row ? row.querySelector('.set-status[data-id="' + id + '"]') : null;
              if (!cell) {
                alert("Status cell not found.");
                return;
              }

              const status = cell.getAttribute("data-status");
              if (!status) {
                alert("No status to update.");
                return;
              }

              // ë²„íŠ¼ì˜ data-reasonì—ì„œ enum ì½”ë“œê°’(ì˜ˆ: PROFANITY) ì·¨ë“
              const reason = btn.getAttribute("data-reason") || null;

              if (!confirm(`Change status to '${status}'?`)) return;

              const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
              const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute("content");
              const headers = { "Content-Type": "application/json" };
              if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

              const payload = reason ? { status, reason } : { status };

              fetch(`/report/${id}/status`, {
                method: "PATCH",
                headers,
                body: JSON.stringify(payload),
              })
                .then((res) => {
                  if (res.status === 204) {
                    btn.textContent = "Updated";
                    setTimeout(() => (btn.textContent = "Update"), 900);
                  } else {
                    throw new Error("Update failed: " + res.status);
                  }
                })
                .catch((err) => {
                  console.error(err);
                  alert("Error updating status.");
                });
            });

            function statusToClass(s) {
              const map = {
                RECEIVED: "status-received",
                WARNING: "status-warning",
                DELETED: "status-deleted",
                NO_ACTION: "status-noaction",
              };
              return map[s] || "";
            }
          })();
        </script>
      </th:block>
    </main>
  </body>
</html>
